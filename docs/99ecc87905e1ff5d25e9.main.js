(()=>{var e={50:e=>{function t(e){return Array.isArray(e)&&(e=e.join(",")),e}e.exports={getPlacmarks:function(){return new Promise((e=>{setTimeout((()=>{e(JSON.parse(localStorage.getItem("placemarks")))}),500)}))},getPlacmark:async function(e){e=t(e);const o=JSON.parse(localStorage.getItem("placemarks")||"{}"),a=o[e]?o[e]:null;return new Promise((e=>{setTimeout((()=>{e(a)}),500)}))},setPlacmark:async function(e,o){e=t(e);const a=JSON.parse(localStorage.getItem("placemarks")||"{}");let n=!1;return a[e]?a[e].push(o):(a[e]=[o],n=!0),new Promise((t=>{setTimeout((()=>{localStorage.setItem("placemarks",JSON.stringify(a)),t(n?{[e]:a[e]}:null)}),500)}))}}},912:(e,t,o)=>{const a=o(50);e.exports={getForm:async function(){const e=document.querySelector("[data-role=review-comments]"),t=document.querySelector("[data-role=review-form]"),o=t.querySelector("[data-role=review-name]"),n=t.querySelector("[data-role=review-place]"),s=t.querySelector("[data-role=review-text]"),r=t.querySelector("[data-role=review-submit]"),l={name:o.value,place:n.value,text:s.value,date:(new Date).toISOString().split("T")[0].split("-").reverse().join(".")};if(!l.name||!l.place)return null;const c=document.createElement("div");c.innerHTML=`\n    <div class="comments__comment">\n      <div>\n        <strong>${l.name}</strong>\n        <span>${l.place}</span>\n      </div>\n      <small>${l.date}</small>\n    </div>\n    <div>${l.text}</div>\n  `,e.append(c),e.scrollTo(0,e.scrollHeight);const i=await a.setPlacmark(r.dataset.coords,l);return o.value=n.value=s.value="",i}}},202:(e,t,o)=>{const a=o(136),n=o(912);function s(e){const t=e.get("coords");a.openBalloon(t)}async function r(e){const t=e.get("target"),o=t.geometry.getCoordinates();t.properties.get("geoObjects",null)?a.openClusterer(t):a.openBalloon(o)}async function l(e){switch(e.preventDefault(),e.target.dataset.role){case"review-close":ymaps.map.balloon.close();break;case"clusterer-link":const t=e.target.dataset.coords.split(",");a.openBalloon(t);break;case"review-submit":const o=await n.getForm();o&&a.createPlacemarks(o)}}e.exports={click:function(){ymaps.map.events.add("click",s),ymaps.map.geoObjects.events.add("click",r),document.body.addEventListener("click",l)}}},136:(e,t,o)=>{const a=o(50),n={iconLayout:"default#image",iconImageHref:"img/marker.png",iconImageSize:[22,33],iconImageOffset:[-11,-33]};async function s(e){return(await new ymaps.geocode(e,{results:1})).geoObjects.get(0).properties.get("name")}e.exports={map:function(e,t){t.innerHTML="",ymaps.map=new ymaps.Map(t,{center:e,zoom:12,controls:["zoomControl"],behaviors:["drag"]})},geoCoder:s,clusterer:function(){ymaps.clusterer=new ymaps.Clusterer({clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!1,clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:"my#clustererItemLayout"}),ymaps.map.geoObjects.add(ymaps.clusterer)},geoLocation:async function(){return(await ymaps.geolocation.get({provider:"auto"})).geoObjects.position},openBalloon:async function(e){ymaps.map.balloon.open(e,"Загрузка...",{closeButton:!1});const t=await a.getPlacmark(e),o={address:await s(e),coords:e,comments:t};ymaps.map.balloon.open(e,o,{layout:"my#customBalloonLayout"})},openClusterer:async function(e){const t=e.geometry.getCoordinates();ymaps.map.balloon.open(t,"Загрузка...",{closeButton:!1});const o=e.getGeoObjects();for(const e of o){const t=e.geometry.getCoordinates(),o=await a.getPlacmark(t),n=await s(t);e.properties.set("comments",o).set("address",n).set("coords",t)}ymaps.map.balloon.close(t),ymaps.clusterer.balloon.open(e)},createPlacemarks:function(e={}){for(let t in e){const o=t.split(","),a=e[t];ymaps.clusterer.add(new ymaps.Placemark(o,a,n))}}}}},t={};function o(a){if(t[a])return t[a].exports;var n=t[a]={exports:{}};return e[a](n,n.exports,o),n.exports}(()=>{const e=document.querySelector("#map"),t=o(136),a=o(202),n=o(50);ymaps.ready((async()=>{console.log("Ymaps ready");const o=document.getElementById("customClustererItemLayout").innerHTML,s=document.getElementById("customBalloonTemplate").innerHTML,r=ymaps.templateLayoutFactory.createClass(o),l=ymaps.templateLayoutFactory.createClass(s,{build:function(){this.constructor.superclass.build.call(this),this._$element=$(".popover",this.getParentElement()),this.applyElementOffset(),this._$element.find(".close").on("click",$.proxy(this.onCloseClick,this))},clear:function(){this._$element.find(".close").off("click"),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){l.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._$element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){this._$element.css({left:-this._$element[0].offsetWidth/2,top:-(this._$element[0].offsetHeight+this._$element.find(".arrow")[0].offsetHeight)})},onCloseClick:function(e){e.preventDefault(),this.events.fire("userclose")},getShape:function(){if(!this._isElement(this._$element))return MyBalloonLayout.superclass.getShape.call(this);var e=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[e.left,e.top],[e.left+this._$element[0].offsetWidth,e.top+this._$element[0].offsetHeight+this._$element.find(".arrow")[0].offsetHeight]]))},_isElement:function(e){return e&&e[0]&&e.find(".arrow")[0]}});ymaps.layout.storage.add("my#customBalloonLayout",l),ymaps.layout.storage.add("my#clustererItemLayout",r);try{const o=await t.geoLocation(),s=await n.getPlacmarks();t.map(o,e),t.clusterer(),t.createPlacemarks(s),a.click()}catch(e){console.log(e)}}))})()})();